	program testit
	use RadParams , only : nvx,nv1x,nv
        common /atmos/ pp(nv1x), pt(nv1x), ph(nv1x), po(nv1x)
	 common /gas/ tg(nvx)

	open(10,file='ksaw.lay')

	read(10,*) skint,nv
	nv1=nv+1
	do i=1,nv1
	read(10,*) pp(i),pt(i),ph(i)
!	print*,I,pp(i),pt(i),ph(i)
	enddo

	do ib = 19,20
	do ig = 1,5

 	call kratzsolir(ib,ig,hk,tg)

!	print*,ib,ig,hk,sum(tg(1:nv))
	enddo
	enddo

	stop
	end
!==============================================================
	subroutine kratzsolir(ib,ig,hk,tgout)
	use RadParams , only : nvx,nv1x,nv
        common /atmos/ pp(nv1x), pt(nv1x), ph(nv1x), po(nv1x)

	real ,save ::hk19(5),hk20(5)
	real ,save ,dimension(5,nvx):: tau19,tau20
	real ,  dimension(nvx):: u,uco2,taun2
	real tgout(nvx)

!------------------------------------------------SETUP

	if ( ig == 1 ) then !SETUP

!--------------
	LEVELS : do i=1,nv
	 dz=0.0146337*(pt(i)+pt(i+1))*alog( pp(i+1)/pp(i))
	 pbar= (pp(i+1)+pp(i))*0.5
	 pbar_atm = pbar/1013.25

	 tbar= (pt(i+1)+pt(i))*0.5

	units =  1.02* (pp(i+1)- pp(i))
        xlog=(log10(ph(i))+log10(ph(i+1)))/2.0
        u(i)= units * 10.0**xlog
! u H2O in g/cm2
!       note that the ratio un2o/uco2 = 0.31/350.0
        uco2(i)=pbar*1000./(1.3805e-16*tbar)*3.40e-04*dz*
     *          1.0e+05/6.023e+23*44.00995
! uco2 CO2 in g/cm2

	call n2cont(u(i),taun2(i),pbar_atm,tbar,dz)

!	print*,i, pbar,dz,u(i),uco2(i)
	enddo LEVELS
!-------------------

	if ( ib == 19 ) then


	call ck19(nvx,nv,hk19,pp,pt,u ,tau19)
!	print*,'Band 19 2850:2500cm-1 H20'
!	print'(20x,5f9.3)',hk19
!	do i=1,nv
!	print'(I3,2f8.1,1x,5f9.3)',I,pp(i),pt(i),tau19(1:5,i)
!	enddo
	endif!19

	if ( ib == 20 ) then

	call ck20(nvx,nv,hk20,pp,pt,uco2 ,tau20)
!	print*,'Band 20 2500:2200cm-1 CO2/N2/H20Cont'
!	print'(20x,5f9.3)',hk20
!
	do i=1,nv
!	print'(I3,2f8.1,1x,5f9.3,1x,f8.4)',I,pp(i),pt(i),tau20(1:5,i),taun2(i)

	do j=1,5
	tau20(j,i)= tau20(j,i)+taun2(i) !! Add N2 Continuum tau  to  total tau
	enddo

	enddo
	endif !20

	endif !!! SET UP
!------------------------------------------------SETUP

	if ( ib == 19 ) then
	 hk    =  hk19(ig)
	 tgout = tau19(ig,1:nv)
	endif

	if ( ib == 20 ) then
	 hk    =  hk20(ig)
	 tgout = tau20(ig,1:nv)
	endif

	return
	end

! *********************************************************************
! 2850:2500
      subroutine ck19(nvx,nv,f,pmb,t,u ,tau19)

      real  f(5), coefk(5,3,19),stp(19)
      real ,dimension(5,nvx) :: tau19,fkg
      real ,  dimension(nvx) :: k,pmb,t,u

      ni=5
      f(1)=0.540525
      f(2)=0.325386
      f(3)=0.113208
      f(4)=0.018729
      f(5)=0.002152
      k(1)=0.004403799
      do i=2,ni
        k(i)=9.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.00289,0.00289,0.00289,0.00289,0.00289,0.00289,
     *0.00289,0.00289,0.00289,0.00951,0.02582,0.05945,
     *0.11560,0.20518,0.33740,0.53335,0.81968,1.21183,
     * 1.72638,
     * 1.650E-05, 1.650E-05, 1.650E-05, 1.650E-05, 1.650E-05, 1.650E-05,
     * 1.650E-05, 1.650E-05, 1.650E-05, 5.188E-05, 1.369E-04, 2.896E-04,
     * 5.031E-04, 9.030E-04, 1.522E-03, 2.397E-03, 3.587E-03, 5.331E-03,
     * 7.600E-03,
     *-3.750E-08,-3.750E-08,-3.750E-08,-3.750E-08,-3.750E-08,-3.750E-08,
     *-3.750E-08,-3.750E-08,-3.750E-08,-4.063E-08,-1.219E-07,-3.781E-07,
     *-3.719E-07,-5.875E-07,-4.094E-07, 2.813E-07,-5.437E-07,-4.625E-07,
     *-4.156E-06/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.02847,0.02847,0.02847,0.02847,0.02847,0.02847,
     *0.02847,0.02847,0.02847,0.05115,0.08641,0.13784,
     *0.21072,0.31333,0.45442,0.63664,0.86713,1.14853,
     * 1.47973,
     * 1.586E-04, 1.586E-04, 1.586E-04, 1.586E-04, 1.586E-04, 1.586E-04,
     * 1.586E-04, 1.586E-04, 1.586E-04, 2.589E-04, 4.210E-04, 6.576E-04,
     * 9.754E-04, 1.372E-03, 1.881E-03, 2.501E-03, 3.177E-03, 4.101E-03,
     * 5.093E-03,
     * 1.281E-07, 1.281E-07, 1.281E-07, 1.281E-07, 1.281E-07, 1.281E-07,
     * 1.281E-07, 1.281E-07, 1.281E-07, 3.031E-07, 6.375E-07, 9.656E-07,
     * 1.559E-06, 2.259E-06, 2.956E-06, 4.541E-06, 5.334E-06, 6.506E-06,
     * 6.975E-06/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.13965,0.13965,0.13965,0.13965,0.13965,0.13965,
     *0.13965,0.13965,0.13965,0.17707,0.22719,0.29287,
     *0.37869,0.48593,0.61628,0.76703,0.92621,1.06693,
     * 1.17271,
     * 1.014E-03, 1.014E-03, 1.014E-03, 1.014E-03, 1.014E-03, 1.014E-03,
     * 1.014E-03, 1.014E-03, 1.014E-03, 1.138E-03, 1.303E-03, 1.535E-03,
     * 1.864E-03, 2.309E-03, 2.901E-03, 3.596E-03, 4.255E-03, 4.870E-03,
     * 5.700E-03,
     * 3.050E-06, 3.050E-06, 3.050E-06, 3.050E-06, 3.050E-06, 3.050E-06,
     * 3.050E-06, 3.050E-06, 3.050E-06, 3.347E-06, 3.656E-06, 4.281E-06,
     * 4.462E-06, 5.175E-06, 5.766E-06, 5.350E-06, 4.356E-06, 4.947E-06,
     * 1.191E-05/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.57831,0.57831,0.57831,0.57831,0.57831,0.57831,
     *0.57831,0.57831,0.57831,0.61983,0.67292,0.73455,
     *0.79400,0.84206,0.88828,0.93195,0.97935,1.02072,
     * 1.05737,
     * 3.927E-03, 3.927E-03, 3.927E-03, 3.927E-03, 3.927E-03, 3.927E-03,
     * 3.927E-03, 3.927E-03, 3.927E-03, 3.873E-03, 3.848E-03, 3.878E-03,
     * 4.043E-03, 4.551E-03, 5.600E-03, 6.955E-03, 8.298E-03, 9.810E-03,
     * 1.106E-02,
     * 1.002E-05, 1.002E-05, 1.002E-05, 1.002E-05, 1.002E-05, 1.002E-05,
     * 1.002E-05, 1.002E-05, 1.002E-05, 8.528E-06, 6.963E-06, 5.544E-06,
     * 7.431E-06, 1.512E-05, 1.966E-05, 2.328E-05, 2.517E-05, 3.052E-05,
     * 2.740E-05/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/
     *2.17420,2.17420,2.17420,2.17420,2.17420,2.17420,
     *2.17420,2.17420,2.17420,2.10770,2.02271,1.91526,
     *1.78961,1.65009,1.48700,1.29866,1.09915,0.89800,
     * 0.71186,
     * 1.878E-02, 1.878E-02, 1.878E-02, 1.878E-02, 1.878E-02, 1.878E-02,
     * 1.878E-02, 1.878E-02, 1.878E-02, 1.869E-02, 1.860E-02, 1.841E-02,
     * 1.798E-02, 1.712E-02, 1.555E-02, 1.353E-02, 1.149E-02, 9.609E-03,
     * 7.682E-03,
     * 4.196E-05, 4.196E-05, 4.196E-05, 4.196E-05, 4.196E-05, 4.196E-05,
     * 4.196E-05, 4.196E-05, 4.196E-05, 4.297E-05, 4.334E-05, 4.307E-05,
     * 4.059E-05, 3.324E-05, 2.752E-05, 2.324E-05, 1.872E-05, 1.642E-05,
     * 1.367E-05/
	data stp / 0.251, 0.398, 0.631, 1.000, 1.58, 2.51,
     *	             3.98, 6.31, 10.0, 15.8, 25.1, 39.8, 63.1,
     *	             100.0, 158.0, 251.0, 398.0, 631.0, 1000.0/
      do i=1,ni
      do m=1,nv
        ml=1
!        pmb(m)=p(m)
        if(pmb(m).lt.stp(1))then
         x1=coefk(i,1,1)+coefk(i,2,1)*(t(m)-250.0)
     *   +coefk(i,3,1)*(t(m)-250.0)**2
         fkg(i,m)=x1*pmb(m)/stp(1)
        else if (pmb(m).gt.stp(19)) then
         x1=coefk(i,1,18)+coefk(i,2,18)*(t(m)-250.0)
     *   +coefk(i,3,18)*(t(m)-250.0)**2
         x2=coefk(i,1,19)+coefk(i,2,19)*(t(m)-250.0)
     *   +coefk(i,3,19)*(t(m)-250.0)**2
         fkg(i,m)=x1+(x2-x1)/(stp(19)-stp(18))
     *  *(pmb(m)-stp(18))
        else
         do while(pmb(m).ge.stp(ml))
           ml=ml+1
         end do
         x1=coefk(i,1,ml-1)+coefk(i,2,ml-1)*(t(m)-250.0)
     *   + coefk(i,3,ml-1)*(t(m)-250.0)**2
         x2=coefk(i,1,ml)+coefk(i,2,ml)*(t(m)-250.0)
     *   + coefk(i,3,ml)*(t(m)-250.0)**2
         fkg(i,m)=x1+(x2-x1)/(stp(ml)-stp(ml-1))
     *   *(pmb(m)-stp(ml-1))
        end if
      end do
      end do

      do i=1,ni
        do m=1,nv
          tau19(i,m)=k(i)*u(m)*fkg(i,m)
        end do
      end do

      return
      end
!====================================================================
!     co2/n2o 2200--2500 cm^{-1}
      subroutine ck20(nvx,nv,f,pmb,t,u,tau20)

      real  f(5), coefk(5,3,19),stp(19)
      real,dimension(5,nvx) :: tau20,fkg
      real ,dimension(nvx) :: k,pmb,t,u

      ni=5
      f(1)=0.458869
      f(2)=0.136554
      f(3)=0.218715
      f(4)=0.167336
      f(5)=0.018526
      k(1)=0.536896
      do i=2,ni
        k(i)=24.0*k(i-1)
      end do
      data ( (coefk(1,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.00000,0.00000,0.00000,0.00000,0.00002,0.00007,
     *0.00027,0.00096,0.00354,0.01207,0.03663,0.08552,
     *0.15861,0.25167,0.38168,0.56692,0.82581,1.20863,
     * 1.88788,
     * 0.000E+00, 0.000E+00, 0.000E+00, 1.000E-07, 5.750E-07, 2.150E-06,
     * 6.813E-06, 2.009E-05, 5.225E-05, 1.396E-04, 4.111E-04, 7.851E-04,
     * 1.309E-03, 1.845E-03, 2.548E-03, 3.657E-03, 4.920E-03,-8.227E-03,
     * 1.188E-03,
     * 0.000E+00, 0.000E+00, 0.000E+00, 1.250E-09, 6.250E-09, 2.375E-08,
     * 6.844E-08, 1.828E-07, 2.937E-07, 8.594E-07, 2.878E-06, 5.178E-06,
     * 8.306E-06, 1.251E-05, 1.484E-05, 1.843E-05, 2.581E-05, 3.784E-04,
     * 6.279E-05/
      data ( (coefk(2,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.00000,0.00000,0.00000,0.00001,0.00002,0.00008,
     *0.00032,0.00134,0.00427,0.01262,0.03899,0.08948,
     *0.16530,0.26665,0.41049,0.59994,0.84701,1.15356,
     * 1.42926,
     * 0.000E+00, 0.000E+00, 0.000E+00, 3.375E-07, 9.625E-07, 2.813E-06,
     * 8.712E-06, 2.591E-05, 6.738E-05, 1.731E-04, 4.314E-04, 8.889E-04,
     * 1.428E-03, 2.146E-03, 2.979E-03, 4.081E-03, 5.356E-03,-4.375E-03,
     * 6.029E-03,
     * 0.000E+00, 0.000E+00, 0.000E+00, 4.688E-09, 1.281E-08, 3.469E-08,
     * 9.656E-08, 2.203E-07, 4.406E-07, 1.109E-06, 2.878E-06, 6.241E-06,
     * 9.200E-06, 1.479E-05, 1.835E-05, 2.261E-05, 2.854E-05, 2.972E-04,
     * 2.707E-05/
      data ( (coefk(3,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.00000,0.00000,0.00000,0.00001,0.00004,0.00012,
     *0.00036,0.00115,0.00337,0.00944,0.02921,0.08402,
     *0.16244,0.26291,0.40574,0.59750,0.84592,1.15582,
     * 1.43050,
     * 0.000E+00, 0.000E+00, 2.875E-07, 6.000E-07, 1.325E-06, 3.100E-06,
     * 7.375E-06, 1.784E-05, 4.312E-05, 1.009E-04, 2.573E-04, 5.689E-04,
     * 1.087E-03, 1.749E-03, 2.657E-03, 4.042E-03, 5.860E-03,-5.549E-03,
     * 9.583E-03,
     * 0.000E+00, 0.000E+00, 4.688E-09, 8.125E-09, 1.563E-08, 3.375E-08,
     * 6.750E-08, 1.347E-07, 2.406E-07, 4.281E-07, 1.394E-06, 1.109E-06,
     * 1.344E-06, 2.600E-06, 2.409E-06, 3.591E-06, 5.947E-06, 3.445E-04,
     * 1.157E-05/
      data ( (coefk(4,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.00033,0.00032,0.00037,0.00058,0.00109,0.00216,
     *0.00429,0.00845,0.01634,0.03141,0.06305,0.12326,
     *0.21023,0.32031,0.45933,0.63241,0.85736,1.14841,
     * 1.43591,
     * 1.216E-05, 1.174E-05, 1.131E-05, 1.576E-05, 2.326E-05, 3.485E-05,
     * 5.263E-05, 7.912E-05, 1.175E-04, 1.620E-04, 2.965E-04, 4.337E-04,
     * 5.642E-04, 7.377E-04, 9.435E-04, 9.828E-04, 7.706E-04,-3.713E-03,
     *-1.563E-03,
     * 1.503E-07, 1.484E-07, 1.297E-07, 1.716E-07, 1.978E-07, 2.481E-07,
     * 3.219E-07, 4.281E-07, 5.625E-07, 4.750E-07, 1.225E-06, 1.625E-06,
     * 2.156E-06, 3.250E-06, 4.331E-06, 6.050E-06, 7.384E-06, 1.036E-04,
     * 1.005E-05/
      data ( (coefk(5,jt,jp), jp = 1, 19), jt = 1, 3)/
     *0.17603,0.15775,0.15166,0.15930,0.18058,0.21548,
     *0.27159,0.35027,0.45092,0.58099,0.78768,1.05426,
     *1.21613,1.26776,1.26045,1.19035,1.06528,0.91460,
     * 0.72367,
     * 1.507E-03, 1.481E-03, 1.325E-03, 1.343E-03, 1.360E-03, 1.377E-03,
     * 1.388E-03, 1.331E-03, 1.238E-03, 9.580E-04, 1.403E-03, 1.144E-03,
     * 6.321E-04, 1.536E-04,-9.625E-06, 3.740E-04, 5.853E-04, 2.204E-03,
     *-2.916E-04,
     * 6.019E-06, 6.538E-06, 6.510E-06, 6.969E-06, 5.497E-06, 5.913E-06,
     * 4.419E-06, 3.403E-06, 9.906E-07,-4.681E-06, 2.534E-06, 2.653E-06,
     * 5.597E-06, 8.784E-06, 9.064E-08,-5.625E-06,-3.094E-06,-4.828E-05,
     *-2.031E-07/
	data stp / 0.251, 0.398, 0.631, 1.000, 1.58, 2.51,
     *	             3.98, 6.31, 10.0, 15.8, 25.1, 39.8, 63.1,
     *	             100.0, 158.0, 251.0, 398.0, 631.0, 1000.0/
      do i=1,ni
      do m=1,nv
        ml=1
!        pmb(m)=p(m)*1013.25
        if(pmb(m).lt.stp(1))then
         x1=coefk(i,1,1)+coefk(i,2,1)*(t(m)-250.0)
     *   +coefk(i,3,1)*(t(m)-250.0)**2
         fkg(i,m)=x1*pmb(m)/stp(1)
        else if (pmb(m).gt.stp(19)) then
         x1=coefk(i,1,18)+coefk(i,2,18)*(t(m)-250.0)
     *   +coefk(i,3,18)*(t(m)-250.0)**2
         x2=coefk(i,1,19)+coefk(i,2,19)*(t(m)-250.0)
     *   +coefk(i,3,19)*(t(m)-250.0)**2
         fkg(i,m)=x1+(x2-x1)/(stp(19)-stp(18))
     *  *(pmb(m)-stp(18))
        else
         do while(pmb(m).ge.stp(ml))
           ml=ml+1
         end do
         x1=coefk(i,1,ml-1)+coefk(i,2,ml-1)*(t(m)-250.0)
     *   + coefk(i,3,ml-1)*(t(m)-250.0)**2
         x2=coefk(i,1,ml)+coefk(i,2,ml)*(t(m)-250.0)
     *   + coefk(i,3,ml)*(t(m)-250.0)**2
         fkg(i,m)=x1+(x2-x1)/(stp(ml)-stp(ml-1))
     *   *(pmb(m)-stp(ml-1))
        end if
      end do
      end do

      do i=1,ni
        do m=1,nv
          tau20(i,m)=k(i)*u(m)*fkg(i,m)
        end do
      end do

      return
      end
c *********************************************************************
      subroutine n2cont (amnt,twin,patm,temp,fac)
c     Parameterization of CKD_2.1 continuum over 2200 to 2500 cm-1 band
c     Fit inaccurate for amnt < 0.01 g/cm*2;
c          however optical depths < 0.001.
c     INPUT:
c     amnt = h2O layer amount (g/cm**2)
c     patm= pressure (atm)
c     temp = temperature (k)
c     OUTPUT:
c     twin = parameterized CKD_2.1 optical depth over band
c
      parameter (ncoef=8)
      real aa(ncoef)
      data aa/-12.23,0.9995,-0.003916,-3.364,
     *         6.360,5.881e-04,-1.001,10.18/
c
      ph2o = amnt*(8.314e+07*temp)/(fac*1.0e+05*18.01534*1.01325e+06)
c
          tau_log   = aa(1)              +
     *                aa(2) * log(amnt)  +
     *                aa(3) * temp       +
     *                aa(4) * patm       +
     *                aa(5) * ph2o       +
     *                aa(6) * amnt       +
     *                aa(7) * log(ph2o)  +
     *                aa(8) * patm**0.5

      twin = exp ( tau_log )
c
      return
      end
